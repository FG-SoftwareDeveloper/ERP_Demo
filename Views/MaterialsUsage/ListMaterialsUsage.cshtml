@{
    Layout = "_Layout";
    // Example data for static design; replace with your model in production
    var usageRecords = new[] {
        new { UsageID = 1, Material = "Concrete", Type = "Bulk", Project = "HQ Expansion", Location = "Site A", Quantity = 40, Unit = "m³", DateUsed = DateTime.Parse("2025-08-28"), Status = "Normal", Cost = 1600m, AIInsights = "Usage within expected range." },
        new { UsageID = 2, Material = "Steel Rebar", Type = "Structural", Project = "Bridge Build", Location = "Site B", Quantity = 10, Unit = "tons", DateUsed = DateTime.Parse("2025-08-25"), Status = "High", Cost = 6000m, AIInsights = "High usage. Reorder recommended." },
        new { UsageID = 3, Material = "Insulation", Type = "Finish", Project = "Warehouse Retrofit", Location = "Site C", Quantity = 50, Unit = "sheets", DateUsed = DateTime.Parse("2025-08-20"), Status = "Low", Cost = 800m, AIInsights = "Low usage. Delivery on schedule." }
    };
}

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glass-effect border-0">
                <div class="card-body p-4 d-flex flex-column flex-md-row align-items-md-center justify-content-between">
                    <div>
                        <h1 class="mb-1 text-themed-primary d-flex align-items-center">
                            <i class="bi bi-diagram-3 me-3 icon-primary fs-2"></i> Material Usage
                        </h1>
                        <p class="text-themed-secondary mb-0">Visualize flows WH?Project, track variances, and detect anomalies.</p>
                    </div>
                    <div class="mt-3 mt-md-0 d-flex flex-wrap gap-2">
                        <button class="btn btn-themed"><i class="bi bi-box-arrow-in-right me-2"></i>Issue Material</button>
                        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#aiAnomaly"><i class="bi bi-robot me-2"></i>Anomaly Scan</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Signature: Flow (Sankey placeholder) + Variance -->
    <div class="row g-4 mb-4">
        <div class="col-xxl-7">
            <div class="card glass-effect border-0 h-100">
                <div class="card-header bg-transparent border-0 p-4"><h5 class="mb-0 text-themed-primary"><i class="bi bi-shuffle me-2 icon-info"></i>Usage Flow (Sankey)</h5></div>
                <div class="card-body p-4">
                    <div class="chart-container"><canvas id="usageSankey"></canvas></div>
                    <small class="text-themed-secondary">Shows material movement from warehouses to projects/work orders.</small>
                </div>
            </div>
        </div>
        <div class="col-xxl-5">
            <div class="card glass-effect border-0 h-100">
                <div class="card-header bg-transparent border-0 p-4"><h5 class="mb-0 text-themed-primary"><i class="bi bi-graph-up-arrow me-2 icon-warning"></i>Plan vs Actual (Variance)</h5></div>
                <div class="card-body p-4">
                    <div class="chart-container mb-3"><canvas id="varianceBar"></canvas></div>
                    <div class="p-3 rounded glass-effect d-flex align-items-center justify-content-between">
                        <div><div class="small text-themed-secondary">Total variance</div><div class="display-6 text-themed-primary">$18.7k</div></div>
                        <button class="btn btn-themed-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#aiAnomaly"><i class="bi bi-robot me-1"></i>Explain</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table with BOM quick-view -->
    <div class="row">
        <div class="col-12">
            <div class="card themed-table border-0">
                <div class="card-header bg-transparent border-0 p-4"><h5 class="mb-0 text-themed-primary"><i class="bi bi-table me-2 icon-primary"></i>Usage Transactions</h5></div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead><tr><th>Usage #</th><th>Date</th><th>Project</th><th>Material</th><th>Qty</th><th>Unit</th><th>Cost</th><th>BOM</th><th>Actions</th></tr></thead>
                            <tbody>
                                <tr>
                                    <td>MU-23045</td>
                                    <td>2025-08-29</td>
                                    <td>PRJ-1002</td>
                                    <td>Steel Rod 10mm</td>
                                    <td>140</td>
                                    <td>pcs</td>
                                    <td>$329</td>
                                    <td><button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#bomQuick"><i class="bi bi-diagram-3"></i></button></td>
                                    <td><button class="btn btn-sm btn-outline-primary"><i class="bi bi-eye"></i></button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="aiAnomaly" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content glass-effect border-0">
            <div class="modal-header"><h5 class="modal-title"><i class="bi bi-robot me-2"></i>AI Variance & Anomalies</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="alert alert-warning"><i class="bi bi-exclamation-triangle me-2"></i>Project PRJ-1005 is 23% over plan for steel. Suspect duplicate issue on 08/25.</div>
                <ul class="small text-themed-secondary mb-0"><li>Auto-create review task for storekeeper</li><li>Lock high-risk SKU for manager approval</li></ul>
            </div>
            <div class="modal-footer"><button class="btn btn-themed-secondary"><i class="bi bi-tools me-1"></i>Create Fix Task</button><button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="bomQuick" tabindex="-1">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content glass-effect border-0">
            <div class="modal-header"><h5 class="modal-title"><i class="bi bi-diagram-3 me-2"></i>BOM Quick View</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <ul class="small mb-0">
                    <li>
                        Assembly A
                        <ul>
                            <li>Steel Rod 10mm × 2</li>
                            <li>Fastener M10 × 6</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
